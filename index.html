<!DOCTYPE html>
<html>
<head>
    <title>Women Safety - REAL Safe Places Finder</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --emergency-red: #ff4757;
            --safe-green: #2ed573;
            --police-blue: #3742fa;
            --hospital-red: #ff6b81;
            --pharmacy-orange: #ffa502;
            --commercial-teal: #1e90ff;
            --bottom-nav-height: 70px;
            --top-bar-height: 60px;
        }
        
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0c2461;
            color: white;
            height: 100vh;
            overflow: hidden;
            touch-action: pan-x pan-y;
        }
        
        /* EMERGENCY TOP BAR */
        .emergency-top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
            color: white;
            padding: 12px 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
            z-index: 1000;
            height: var(--top-bar-height);
        }
        
        .emergency-top-bar h1 {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: nowrap;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .emergency-top-bar p {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* HAMBURGER MENU */
        .menu-btn {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }
        
        /* MAIN CONTAINER */
        .main-container {
            position: fixed;
            top: var(--top-bar-height);
            left: 0;
            right: 0;
            bottom: var(--bottom-nav-height);
            display: flex;
            flex-direction: column;
        }
        
        /* MAP */
        #map { 
            flex: 1;
            width: 100%;
            z-index: 1;
        }
        
        /* BOTTOM NAVIGATION */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            height: var(--bottom-nav-height);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            height: 100%;
            background: transparent;
            border: none;
            color: #666;
            font-size: 10px;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .nav-item.active {
            color: #3742fa;
            background: rgba(55, 66, 250, 0.05);
        }
        
        .nav-item i {
            font-size: 20px;
        }
        
        .nav-item.emergency {
            color: #ff4757;
        }
        
        /* MAP CONTROLS OVERLAY */
        .map-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .map-control-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 3px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #3742fa;
            cursor: pointer;
        }
        
        /* SIDE PANEL */
        .side-panel {
            position: fixed;
            top: var(--top-bar-height);
            right: -100%;
            bottom: var(--bottom-nav-height);
            width: 100%;
            background: white;
            z-index: 1005;
            transition: right 0.3s ease;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px 15px;
            color: #333;
        }
        
        .side-panel.active {
            right: 0;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-panel {
            background: #f8f9fa;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            color: #666;
            cursor: pointer;
        }
        
        /* QUICK ACTIONS */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .action-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .action-btn:active {
            transform: scale(0.98);
        }
        
        .action-btn.primary {
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
            color: white;
            border: none;
            font-weight: bold;
            grid-column: span 2;
        }
        
        .action-btn .icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .action-btn .label {
            font-size: 12px;
            font-weight: bold;
            line-height: 1.2;
        }
        
        .action-btn small {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        /* FILTER BUTTONS */
        .filter-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 15px 0;
            margin-bottom: 20px;
            -webkit-overflow-scrolling: touch;
        }
        
        .filter-btn {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 20px;
            padding: 10px 16px;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .filter-btn.active {
            background: #3742fa;
            color: white;
            border-color: #3742fa;
        }
        
        /* SAFE PLACES LIST */
        .places-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .place-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid var(--police-blue);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .place-card:active {
            transform: scale(0.99);
        }
        
        .place-card.police { border-left-color: var(--police-blue); }
        .place-card.hospital { border-left-color: var(--hospital-red); }
        .place-card.pharmacy { border-left-color: var(--pharmacy-orange); }
        .place-card.commercial { border-left-color: var(--commercial-teal); }
        
        .place-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .place-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 15px;
            flex: 1;
            line-height: 1.3;
        }
        
        .place-distance {
            background: #f8f9fa;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 13px;
            margin-left: 10px;
            flex-shrink: 0;
        }
        
        .place-address {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .place-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .place-type {
            font-size: 11px;
            padding: 4px 12px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
        }
        
        .type-police { background: var(--police-blue); }
        .type-pharmacy { background: var(--pharmacy-orange); }
        .type-hospital { background: var(--hospital-red); }
        .type-commercial { background: var(--commercial-teal); }
        
        .place-time {
            font-size: 12px;
            color: #27ae60;
            font-weight: bold;
        }
        
        /* LOADING SCREEN */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(12, 36, 97, 0.98);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.3s;
            padding: 20px;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #2ed573;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        /* EMERGENCY MODAL */
        .emergency-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .emergency-modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px 20px;
            width: 100%;
            max-width: 320px;
            text-align: center;
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* STATUS BAR */
        .status-bar {
            position: fixed;
            bottom: calc(var(--bottom-nav-height) + 10px);
            left: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 15px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: bold;
            z-index: 1001;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2c3e50;
            backdrop-filter: blur(10px);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2ed573;
            animation: pulse 2s infinite;
            flex-shrink: 0;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* MAP LEGEND */
        .map-legend {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 12px;
            font-size: 11px;
            color: #333;
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            max-width: 180px;
            backdrop-filter: blur(5px);
            display: none;
        }
        
        .map-legend.active {
            display: block;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        /* SWIPE INDICATOR */
        .swipe-indicator {
            position: absolute;
            bottom: var(--bottom-nav-height);
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(55, 66, 250, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }
        
        .swipe-handle {
            width: 40px;
            height: 4px;
            background: #3742fa;
            border-radius: 2px;
        }
        
        /* TOUCH-FRIENDLY BUTTONS */
        .touch-btn {
            padding: 15px 20px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }
        
        .touch-btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        /* SEARCH BAR */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 15px 45px 15px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            color: #333;
        }
        
        .search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            font-size: 18px;
            cursor: pointer;
        }
        
        /* SAFE ROUTE HIGHLIGHT */
        .safe-route {
            stroke-dasharray: 10, 10;
            animation: dash 1s linear infinite;
        }
        
        @keyframes dash {
            to { stroke-dashoffset: 20; }
        }
        
        /* MEDIA QUERIES FOR EXTRA SMALL SCREENS */
        @media (max-width: 360px) {
            .emergency-top-bar h1 {
                font-size: 16px;
            }
            
            .action-btn .label {
                font-size: 11px;
            }
            
            .place-name {
                font-size: 14px;
            }
            
            .filter-btn {
                padding: 8px 14px;
                font-size: 12px;
            }
        }
        
        /* LANDSCAPE MODE ADJUSTMENTS */
        @media (orientation: landscape) and (max-height: 500px) {
            .emergency-top-bar {
                height: 50px;
                padding: 8px 15px;
            }
            
            .emergency-top-bar h1 {
                font-size: 16px;
            }
            
            .main-container {
                top: 50px;
                bottom: 60px;
            }
            
            .bottom-nav {
                height: 60px;
            }
            
            .side-panel {
                top: 50px;
                bottom: 60px;
                max-width: 400px;
            }
        }
        
        /* DARK MODE SUPPORT */
        @media (prefers-color-scheme: dark) {
            .side-panel,
            .place-card,
            .action-btn,
            .modal-content,
            .map-legend,
            .status-bar {
                background: #1a1a1a;
                color: #fff;
            }
            
            .place-card {
                border-left-color: #333;
            }
            
            .place-name,
            .place-distance {
                color: #fff;
            }
            
            .place-distance {
                background: #333;
            }
            
            .filter-btn {
                background: #333;
                border-color: #444;
                color: #fff;
            }
            
            .filter-btn.active {
                background: #3742fa;
            }
            
            .search-input {
                background: #333;
                color: #fff;
                border-color: #444;
            }
        }
        
        /* SAFE AREA INSETS FOR NOTCHED PHONES */
        @supports(padding: max(0px)) {
            .bottom-nav {
                padding-bottom: max(15px, env(safe-area-inset-bottom));
            }
            
            .main-container {
                top: max(var(--top-bar-height), env(safe-area-inset-top));
            }
        }
    </style>
</head>
<body>

    <!-- EMERGENCY TOP BAR -->
    <div class="emergency-top-bar">
        <button class="menu-btn" onclick="toggleSidePanel()">
            <i class="fas fa-bars"></i>
        </button>
        <div>
            <h1>
                <i class="fas fa-shield-alt"></i>
                WOMEN SAFETY
                <i class="fas fa-exclamation-triangle"></i>
            </h1>
            <p>Real-time safe places near you</p>
        </div>
    </div>

    <!-- SWIPE INDICATOR -->
    <div class="swipe-indicator">
        <div class="swipe-handle"></div>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="main-container">
        <div id="map"></div>
        
        <!-- MAP CONTROLS -->
        <div class="map-controls">
            <button class="map-control-btn" onclick="focusOnUser()" title="My Location">
                <i class="fas fa-location-crosshairs"></i>
            </button>
            <button class="map-control-btn" onclick="toggleLegend()" title="Legend">
                <i class="fas fa-layer-group"></i>
            </button>
        </div>
        
        <!-- MAP LEGEND -->
        <div class="map-legend" id="mapLegend">
            <h4 style="margin: 0 0 10px 0;">Real Places</h4>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--police-blue);"></div>
                <span>Police Stations</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--hospital-red);"></div>
                <span>Hospitals</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--pharmacy-orange);"></div>
                <span>Pharmacies</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--commercial-teal);"></div>
                <span>24x7 Shops</span>
            </div>
        </div>
    </div>

    <!-- STATUS BAR -->
    <div class="status-bar">
        <div class="status-dot"></div>
        <span id="statusText">Getting your location...</span>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="showMapView()">
            <i class="fas fa-map-marker-alt"></i>
            <span>Map</span>
        </button>
        <button class="nav-item" onclick="showPlacesView()">
            <i class="fas fa-list"></i>
            <span>Places</span>
        </button>
        <button class="nav-item" onclick="showEmergencyView()">
            <i class="fas fa-exclamation-circle"></i>
            <span>Safety</span>
        </button>
        <button class="nav-item emergency" onclick="triggerEmergencySOS()">
            <i class="fas fa-sos"></i>
            <span>SOS</span>
        </button>
    </div>

    <!-- SIDE PANEL -->
    <div class="side-panel" id="sidePanel">
        <div class="panel-header">
            <h2 style="color: #2c3e50;">Safe Places Nearby</h2>
            <button class="close-panel" onclick="toggleSidePanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- SEARCH BAR -->
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search safe places..." id="searchInput">
            <button class="search-btn">
                <i class="fas fa-search"></i>
            </button>
        </div>
        
        <!-- QUICK ACTIONS -->
        <div class="quick-actions" id="quickActions">
            <!-- Dynamically populated -->
        </div>
        
        <!-- FILTER BUTTONS -->
        <div class="filter-scroll" id="filterButtons">
            <!-- Dynamically populated -->
        </div>
        
        <!-- SAFE PLACES LIST -->
        <div class="places-list" id="placesContainer">
            <!-- Real places will be loaded here -->
        </div>
    </div>

    <!-- LOADING SCREEN -->
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
        <h3 style="color: white; margin-bottom: 10px; text-align: center;">Finding real safe places...</h3>
        <p style="color: rgba(255,255,255,0.8); text-align: center; font-size: 14px;">
            Scanning for police, hospitals, pharmacies and 24x7 establishments
        </p>
    </div>

    <!-- EMERGENCY MODAL -->
    <div class="emergency-modal" id="emergencyModal">
        <div class="modal-content">
            <i class="fas fa-exclamation-triangle" style="font-size: 60px; color: #ff4757; margin-bottom: 20px;"></i>
            <h2 style="color: #ff4757; margin-bottom: 10px;">EMERGENCY SOS</h2>
            <p style="color: #666; margin-bottom: 25px; font-size: 15px;">
                Police and emergency contacts will be notified in:
            </p>
            <div class="countdown" id="countdown" style="font-size: 48px; font-weight: bold; color: #ff4757; margin: 20px 0;">5</div>
            <button class="touch-btn" onclick="cancelEmergency()" style="background: #f1f2f6; color: #333;">
                CANCEL EMERGENCY
            </button>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const OVERPASS_API = 'https://overpass-api.de/api/interpreter';
        let userLocation = null;
        let map = null;
        let allRealPlaces = [];
        let currentMarkers = [];
        let currentFilter = 'all';
        let sidePanelOpen = false;
        let activeView = 'map';
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            getUserLocation();
            setupTouchEvents();
            updateStatus("Initializing safety system...");
        });
        
        function initializeMap() {
            map = L.map('map').setView([22.5726, 88.3639], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap | Women Safety'
            }).addTo(map);
            
            // Disable drag on mobile for better touch
            map.touchZoom.disable();
            map.doubleClickZoom.disable();
            
            // Add scale for mobile
            L.control.scale({ 
                imperial: false,
                position: 'bottomleft'
            }).addTo(map);
        }
        
        function setupTouchEvents() {
            // Swipe to open panel
            let startY;
            const panel = document.getElementById('sidePanel');
            
            document.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
            });
            
            document.addEventListener('touchmove', (e) => {
                if (!startY) return;
                
                const currentY = e.touches[0].clientY;
                const diff = startY - currentY;
                
                // Vertical swipe up to open panel
                if (diff > 50 && !sidePanelOpen) {
                    toggleSidePanel();
                    startY = null;
                }
            });
        }
        
        // ==================== GET USER LOCATION ====================
        function getUserLocation() {
            updateStatus("üìç Getting your location...");
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        console.log("User location:", userLocation);
                        
                        // Center map on user
                        focusOnUser();
                        
                        // Find REAL places
                        findRealSafePlaces();
                    },
                    error => {
                        console.error("Geolocation failed:", error);
                        updateStatus("‚ö†Ô∏è Using default location. Enable GPS.");
                        userLocation = [22.5726, 88.3639];
                        findRealSafePlaces();
                    },
                    { 
                        enableHighAccuracy: true, 
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                updateStatus("‚ö†Ô∏è Geolocation not supported");
                userLocation = [22.5726, 88.3639];
                findRealSafePlaces();
            }
        }
        
        // ==================== FIND REAL SAFE PLACES ====================
        async function findRealSafePlaces() {
            updateStatus("üîç Searching for safe places...");
            showLoading(true);
            
            if (!userLocation) {
                updateStatus("‚ùå No location data");
                showLoading(false);
                return;
            }
            
            const [lat, lng] = userLocation;
            allRealPlaces = [];
            
            try {
                // Search for police stations
                const policePlaces = await searchOverpass(
                    `[out:json];
                    node["amenity"="police"](around:2000,${lat},${lng});
                    out body;`,
                    'police'
                );
                
                // Search for pharmacies
                const pharmacyPlaces = await searchOverpass(
                    `[out:json];
                    (node["amenity"="pharmacy"](around:1000,${lat},${lng});
                    node["healthcare"="pharmacy"](around:1000,${lat},${lng}););
                    out body;`,
                    'pharmacy'
                );
                
                // Search for hospitals
                const hospitalPlaces = await searchOverpass(
                    `[out:json];
                    (node["amenity"="hospital"](around:2000,${lat},${lng});
                    node["amenity"="clinic"](around:2000,${lat},${lng});
                    node["healthcare"="hospital"](around:2000,${lat},${lng}););
                    out body;`,
                    'hospital'
                );
                
                // Search for commercial places
                const commercialPlaces = await searchOverpass(
                    `[out:json];
                    (node["shop"](around:1000,${lat},${lng});
                    node["amenity"="fast_food"](around:1000,${lat},${lng});
                    node["amenity"="cafe"](around:1000,${lat},${lng}););
                    out body;`,
                    'commercial'
                );
                
                // Combine results
                allRealPlaces = [
                    ...policePlaces,
                    ...pharmacyPlaces,
                    ...hospitalPlaces,
                    ...commercialPlaces
                ];
                
                // Calculate distances
                allRealPlaces.forEach(place => {
                    place.distance = calculateDistance(
                        userLocation[0], userLocation[1],
                        place.lat, place.lon
                    );
                    place.walkingTime = Math.round((place.distance / 80) * 60);
                });
                
                allRealPlaces.sort((a, b) => a.distance - b.distance);
                
                // Update UI
                updateUIElements();
                updateStatus(`‚úÖ Found ${allRealPlaces.length} safe places`);
                showLoading(false);
                
            } catch (error) {
                console.error("Search error:", error);
                updateStatus("‚ùå Search failed");
                showSampleData();
                showLoading(false);
            }
        }
        
        async function searchOverpass(query, type) {
            try {
                const response = await fetch(`${OVERPASS_API}?data=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                return data.elements.map(element => {
                    let name = 'Unknown Place';
                    if (element.tags) {
                        name = element.tags.name || 
                               element.tags['name:en'] || 
                               element.tags.brand || 
                               type.charAt(0).toUpperCase() + type.slice(1);
                    }
                    
                    const address = element.tags?.['addr:street'] || 
                                   element.tags?.['addr:full'] || 
                                   'Address not available';
                    
                    return {
                        type: type,
                        name: name,
                        lat: element.lat,
                        lon: element.lon,
                        address: address,
                        tags: element.tags || {},
                        id: element.id
                    };
                });
            } catch (error) {
                console.error(`Error: ${type}`, error);
                return [];
            }
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c * 1000;
        }
        
        // ==================== UI UPDATES ====================
        function updateUIElements() {
            updateFilterButtons();
            updatePlacesDisplay();
            updateQuickActions();
            updateMapMarkers();
        }
        
        function updateFilterButtons() {
            const container = document.getElementById('filterButtons');
            const filters = [
                { id: 'all', label: 'All Places', icon: 'fas fa-layer-group' },
                { id: 'police', label: 'Police', icon: 'fas fa-shield-alt' },
                { id: 'pharmacy', label: 'Pharmacy', icon: 'fas fa-pills' },
                { id: 'hospital', label: 'Hospital', icon: 'fas fa-hospital' },
                { id: 'commercial', label: '24x7', icon: 'fas fa-store' },
                { id: 'refresh', label: 'Refresh', icon: 'fas fa-sync-alt' }
            ];
            
            container.innerHTML = filters.map(filter => `
                <button class="filter-btn ${filter.id === currentFilter ? 'active' : ''}" 
                        onclick="filterPlaces('${filter.id}')">
                    <i class="${filter.icon}"></i> ${filter.label}
                </button>
            `).join('');
        }
        
        function updatePlacesDisplay() {
            const container = document.getElementById('placesContainer');
            
            let filteredPlaces = allRealPlaces;
            if (currentFilter !== 'all' && currentFilter !== 'refresh') {
                filteredPlaces = allRealPlaces.filter(p => p.type === currentFilter);
            }
            
            if (filteredPlaces.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <i class="fas fa-search" style="font-size: 40px; margin-bottom: 15px; color: #ffa502;"></i>
                        <h3 style="margin-bottom: 10px;">No places found</h3>
                        <p>Try increasing search area</p>
                    </div>
                `;
                return;
            }
            
            const placesToShow = filteredPlaces.slice(0, 10);
            
            container.innerHTML = placesToShow.map(place => {
                const typeColors = {
                    'police': 'var(--police-blue)',
                    'pharmacy': 'var(--pharmacy-orange)',
                    'hospital': 'var(--hospital-red)',
                    'commercial': 'var(--commercial-teal)'
                };
                
                const typeIcons = {
                    'police': 'fas fa-shield-alt',
                    'pharmacy': 'fas fa-pills',
                    'hospital': 'fas fa-hospital',
                    'commercial': 'fas fa-store'
                };
                
                const typeLabels = {
                    'police': 'Police',
                    'pharmacy': 'Pharmacy',
                    'hospital': 'Hospital',
                    'commercial': '24x7'
                };
                
                return `
                    <div class="place-card ${place.type}" 
                         onclick="navigateToPlace(${JSON.stringify(place).replace(/"/g, '&quot;')})"
                         data-place-id="${place.id}">
                        <div class="place-header">
                            <div class="place-name">
                                <i class="${typeIcons[place.type]}" 
                                   style="color: ${typeColors[place.type]}; margin-right: 8px;"></i>
                                ${place.name}
                            </div>
                            <div class="place-distance">${Math.round(place.distance)}m</div>
                        </div>
                        <div class="place-address">${place.address}</div>
                        <div class="place-meta">
                            <span class="place-type type-${place.type}">${typeLabels[place.type]}</span>
                            <span class="place-time">${place.walkingTime} min walk</span>
                        </div>
                        ${place.tags.phone ? `
                            <div style="margin-top: 10px;">
                                <button onclick="callNumber('${place.tags.phone}'); event.stopPropagation();" 
                                        style="padding: 6px 12px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; color: #3742fa;">
                                    <i class="fas fa-phone"></i> Call
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function updateQuickActions() {
            const container = document.getElementById('quickActions');
            
            const closestPolice = allRealPlaces.filter(p => p.type === 'police')[0];
            const closestPharmacy = allRealPlaces.filter(p => p.type === 'pharmacy')[0];
            const closestHospital = allRealPlaces.filter(p => p.type === 'hospital')[0];
            const closestCommercial = allRealPlaces.filter(p => p.type === 'commercial')[0];
            
            container.innerHTML = `
                <div class="action-btn police" onclick="${closestPolice ? `navigateToPlace(${JSON.stringify(closestPolice)})` : 'alert(\'No police found\')'}">
                    <div class="icon"><i class="fas fa-shield-alt"></i></div>
                    <div class="label">NEAREST POLICE</div>
                    <small>${closestPolice ? Math.round(closestPolice.distance) + 'm' : 'Not found'}</small>
                </div>
                
                <div class="action-btn" onclick="${closestHospital ? `navigateToPlace(${JSON.stringify(closestHospital)})` : 'alert(\'No hospital found\')'}">
                    <div class="icon"><i class="fas fa-hospital"></i></div>
                    <div class="label">NEAREST HOSPITAL</div>
                    <small>${closestHospital ? Math.round(closestHospital.distance) + 'm' : 'Not found'}</small>
                </div>
                
                <div class="action-btn primary" onclick="triggerEmergencySOS()">
                    <div class="icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="label">EMERGENCY SOS</div>
                    <small>Immediate help</small>
                </div>
                
                <div class="action-btn" onclick="shareMyLocation()">
                    <div class="icon"><i class="fas fa-share-alt"></i></div>
                    <div class="label">SHARE LOCATION</div>
                    <small>With trusted contacts</small>
                </div>
            `;
        }
        
        function updateMapMarkers() {
            // Clear existing markers
            currentMarkers.forEach(marker => map.removeLayer(marker));
            currentMarkers = [];
            
            // Add user marker
            if (userLocation) {
                const userMarker = L.circleMarker(userLocation, {
                    color: '#2ed573',
                    fillColor: '#2ed573',
                    fillOpacity: 0.8,
                    radius: 8,
                    weight: 3
                }).addTo(map);
                
                userMarker.bindPopup("<strong>üìç You are here</strong>");
                currentMarkers.push(userMarker);
            }
            
            // Add place markers
            allRealPlaces.forEach(place => {
                const iconColors = {
                    'police': 'var(--police-blue)',
                    'pharmacy': 'var(--pharmacy-orange)',
                    'hospital': 'var(--hospital-red)',
                    'commercial': 'var(--commercial-teal)'
                };
                
                const iconClasses = {
                    'police': 'fas fa-shield-alt',
                    'pharmacy': 'fas fa-pills',
                    'hospital': 'fas fa-hospital',
                    'commercial': 'fas fa-store'
                };
                
                const marker = L.marker([place.lat, place.lon], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `
                            <div style="
                                background: white;
                                width: 40px;
                                height: 40px;
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                border: 3px solid ${iconColors[place.type]};
                                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                            ">
                                <i class="${iconClasses[place.type]}" 
                                   style="color: ${iconColors[place.type]}; font-size: 18px;"></i>
                            </div>
                        `,
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    })
                }).addTo(map);
                
                marker.bindPopup(`
                    <div style="min-width: 200px;">
                        <h4 style="margin: 0 0 8px 0;">${place.name}</h4>
                        <p style="margin: 4px 0; font-size: 13px; color: #666;">${place.address}</p>
                        <p style="margin: 4px 0;"><strong>${Math.round(place.distance)}m away</strong></p>
                        <p style="margin: 4px 0;">${place.walkingTime} min walk</p>
                        ${place.tags.phone ? `
                            <button onclick="callNumber('${place.tags.phone}')" 
                                    style="margin-top: 10px; padding: 8px 16px; background: #3742fa; color: white; border: none; border-radius: 6px; width: 100%;">
                                <i class="fas fa-phone"></i> Call Now
                            </button>
                        ` : ''}
                        <button onclick="navigateToPlace(${JSON.stringify(place).replace(/"/g, '&quot;')})" 
                                style="margin-top: 8px; padding: 8px 16px; background: #2ed573; color: white; border: none; border-radius: 6px; width: 100%;">
                            <i class="fas fa-directions"></i> Get Directions
                        </button>
                    </div>
                `);
                
                currentMarkers.push(marker);
            });
        }
        
        // ==================== NAVIGATION & VIEWS ====================
        function toggleSidePanel() {
            const panel = document.getElementById('sidePanel');
            sidePanelOpen = !sidePanelOpen;
            panel.classList.toggle('active', sidePanelOpen);
            
            if (sidePanelOpen) {
                updateFilterButtons();
                updatePlacesDisplay();
            }
        }
        
        function showMapView() {
            activeView = 'map';
            updateNavButtons();
            toggleSidePanel();
            if (sidePanelOpen) toggleSidePanel();
        }
        
        function showPlacesView() {
            activeView = 'places';
            updateNavButtons();
            if (!sidePanelOpen) toggleSidePanel();
        }
        
        function showEmergencyView() {
            activeView = 'emergency';
            updateNavButtons();
            alert("Emergency features:\n\n‚Ä¢ SOS button for immediate help\n‚Ä¢ Share location with trusted contacts\n‚Ä¢ Nearest safe places navigation");
        }
        
        function updateNavButtons() {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        function focusOnUser() {
            if (userLocation) {
                map.setView(userLocation, 16);
                updateStatus("üìç Centered on your location");
            }
        }
        
        function toggleLegend() {
            document.getElementById('mapLegend').classList.toggle('active');
        }
        
        // ==================== PLACE NAVIGATION ====================
        function navigateToPlace(place) {
            if (!place || !userLocation) return;
            
            updateStatus(`üó∫Ô∏è Navigating to ${place.name}...`);
            
            // Clear previous routes
            map.eachLayer(layer => {
                if (layer instanceof L.Polyline) {
                    map.removeLayer(layer);
                }
            });
            
            // Draw route with animation
            const route = L.polyline([userLocation, [place.lat, place.lon]], {
                color: getPlaceColor(place.type),
                weight: 4,
                opacity: 0.7,
                lineJoin: 'round',
                className: 'safe-route'
            }).addTo(map);
            
            // Open popup
            map.openPopup(`
                <div style="text-align:center; min-width: 250px;">
                    <h4 style="margin: 0 0 10px 0;">${place.name}</h4>
                    <p style="margin: 5px 0;"><strong>${Math.round(place.distance)}m away</strong></p>
                    <p style="margin: 5px 0;">${place.walkingTime} minute walk</p>
                    <button onclick="callNumber('${place.tags.phone || '100'}')" 
                            style="margin: 10px 5px; padding: 10px; background: #3742fa; color: white; border: none; border-radius: 8px; width: 45%;">
                        <i class="fas fa-phone"></i> Call
                    </button>
                    <button onclick="sharePlace('${place.name}', ${place.lat}, ${place.lon})" 
                            style="margin: 10px 5px; padding: 10px; background: #2ed573; color: white; border: none; border-radius: 8px; width: 45%;">
                        <i class="fas fa-share"></i> Share
                    </button>
                </div>
            `, [place.lat, place.lon]);
            
            // Fit bounds
            const bounds = L.latLngBounds([userLocation, [place.lat, place.lon]]);
            map.fitBounds(bounds, { padding: [50, 50] });
            
            // Vibrate on mobile
            if (navigator.vibrate) {
                navigator.vibrate(100);
            }
        }
        
        function getPlaceColor(type) {
            const colors = {
                'police': '#3742fa',
                'pharmacy': '#ffa502',
                'hospital': '#ff6b81',
                'commercial': '#1e90ff'
            };
            return colors[type] || '#666';
        }
        
        // ==================== EMERGENCY FEATURES ====================
        function triggerEmergencySOS() {
            document.getElementById('emergencyModal').classList.add('active');
            
            let countdown = 5;
            const countdownElement = document.getElementById('countdown');
            
            const interval = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(interval);
                    activateEmergency();
                }
            }, 1000);
        }
        
        function cancelEmergency() {
            document.getElementById('emergencyModal').classList.remove('active');
            updateStatus("Emergency cancelled");
        }
        
        function activateEmergency() {
            document.getElementById('emergencyModal').classList.remove('active');
            
            // Call emergency numbers
            callEmergency('100');
            callEmergency('1091'); // Women's helpline India
            
            // Share location
            shareEmergencyLocation();
            
            // Navigate to closest place
            const closestPlace = allRealPlaces[0];
            if (closestPlace) {
                setTimeout(() => navigateToPlace(closestPlace), 1000);
            }
            
            // Alert user
            alert(`üö® EMERGENCY SOS ACTIVATED!\n\n‚Ä¢ Police notified (100)\n‚Ä¢ Women's helpline called (1091)\n‚Ä¢ Location shared with emergency contacts\n‚Ä¢ Navigating to nearest safe place`);
            
            updateStatus("üö® EMERGENCY - Help is on the way");
            
            // Continuous vibration
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
        }
        
        function callEmergency(number) {
            window.open(`tel:${number}`, '_blank');
        }
        
        function callNumber(number) {
            window.open(`tel:${number}`, '_blank');
        }
        
        function shareEmergencyLocation() {
            if (!userLocation) return;
            
            const message = `üö® EMERGENCY SOS! I need immediate help at: https://maps.google.com/?q=${userLocation[0]},${userLocation[1]}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'EMERGENCY - Need Help',
                    text: message
                });
            } else {
                navigator.clipboard.writeText(message);
                alert("Emergency location copied to clipboard!");
            }
        }
        
        function shareMyLocation() {
            if (!userLocation) return;
            
            const message = `üìç My current location: https://maps.google.com/?q=${userLocation[0]},${userLocation[1]}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'My Current Location',
                    text: message
                });
            } else {
                navigator.clipboard.writeText(message);
                alert("Location copied to clipboard!");
            }
        }
        
        function sharePlace(name, lat, lon) {
            const message = `üìç ${name} location: https://maps.google.com/?q=${lat},${lon}`;
            
            if (navigator.share) {
                navigator.share({
                    title: name,
                    text: message
                });
            } else {
                navigator.clipboard.writeText(message);
                alert("Location copied!");
            }
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }
        
        function showLoading(show) {
            document.getElementById('loadingScreen').classList.toggle('hidden', !show);
        }
        
        function filterPlaces(type) {
            if (type === 'refresh') {
                findRealSafePlaces();
                return;
            }
            
            currentFilter = type;
            updateFilterButtons();
            updatePlacesDisplay();
            updateStatus(`Showing ${type === 'all' ? 'all' : type} places`);
        }
        
        // ==================== FALLBACK DATA ====================
        function showSampleData() {
            allRealPlaces = [
                {
                    type: 'police',
                    name: 'Lalbazar Police HQ',
                    lat: 22.5736,
                    lon: 88.3521,
                    distance: 800,
                    walkingTime: 10,
                    address: '18, Lalbazar Street, Kolkata',
                    tags: { phone: '033-2214-3000' }
                },
                {
                    type: 'hospital',
                    name: 'SSKM Hospital',
                    lat: 22.5535,
                    lon: 88.3501,
                    distance: 1200,
                    walkingTime: 15,
                    address: 'Bhowanipore, Kolkata',
                    tags: { phone: '033-2223-5181' }
                },
                {
                    type: 'pharmacy',
                    name: 'Apollo Pharmacy',
                    lat: 22.5750,
                    lon: 88.3620,
                    distance: 500,
                    walkingTime: 6,
                    address: 'Park Street, Kolkata',
                    tags: { phone: '033-2283-5678' }
                },
                {
                    type: 'commercial',
                    name: 'New Market Area',
                    lat: 22.5620,
                    lon: 88.3520,
                    distance: 600,
                    walkingTime: 8,
                    address: 'Lindsay Street, Kolkata',
                    tags: {}
                }
            ];
            
            updateUIElements();
            updateStatus("Showing sample data");
        }

        // ==================== SEARCH FUNCTIONALITY ====================
        document.getElementById('searchInput')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            if (searchTerm.length < 2) {
                updatePlacesDisplay();
                return;
            }
            
            const filtered = allRealPlaces.filter(place => 
                place.name.toLowerCase().includes(searchTerm) ||
                place.address.toLowerCase().includes(searchTerm) ||
                place.type.toLowerCase().includes(searchTerm)
            );
            
            const container = document.getElementById('placesContainer');
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <i class="fas fa-search" style="font-size: 40px; margin-bottom: 15px; color: #ffa502;"></i>
                        <h3 style="margin-bottom: 10px;">No matches found</h3>
                        <p>Try a different search term</p>
                    </div>
                `;
            } else {
                // Temporarily display search results
                const tempPlaces = allRealPlaces;
                allRealPlaces = filtered;
                updatePlacesDisplay();
                allRealPlaces = tempPlaces;
            }
        });

    </script>
</body>
</html>